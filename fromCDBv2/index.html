<!doctype html>
<html lang="ru">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>CrossDaunBot Statistics</title>
        <link
            rel="stylesheet"
            href="{{ url_for('static', filename='style.css') }}" />
        <link rel="icon" href="/static/chat_icon_64.png" type="image/png" />
    </head>
    <body>
        <div class="container">
            <div class="header-section">
                <div>
                    <h2>
                        CrossDaun
                        <span style="color: var(--accent)">Users</span>
                    </h2>
                    <p class="text-muted">–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–≤–æ–¥—á–∞–Ω</p>
                </div>
                <input
                    type="text"
                    id="searchInput"
                    class="search-box"
                    placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è..." />
            </div>

            <div class="dashboard-card">
                <div class="table-responsive">
                    <table id="usersTable">
                        <thead>
                            <tr>
                                <th onclick="sortTable(0)">
                                    ID <span class="sort-icon">‚Üï</span>
                                </th>
                                <th>–ê–≤–∞—Ç–∞—Ä</th>
                                <th onclick="sortTable(2)">
                                    –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                                    <span class="sort-icon">‚Üï</span>
                                </th>
                                <th onclick="sortTable(3)">
                                    TG ID <span class="sort-icon">‚Üï</span>
                                </th>
                                <th onclick="sortTable(4)" class="text-center">
                                    –°–æ–æ–±—â–µ–Ω–∏—è <span class="sort-icon">‚Üï</span>
                                </th>
                                <th onclick="sortTable(5)" class="text-center">
                                    –ú–µ–¥–∏–∞ <span class="sort-icon">‚Üï</span>
                                </th>
                                <th onclick="sortTable(6)" class="text-center">
                                    –°—Ç–∏–∫–µ—Ä—ã <span class="sort-icon">‚Üï</span>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            {% for user in users %}
                            <tr>
                                <td class="small">#{{ user.id }}</td>
                                <td>
                                    <img
                                        src="{{ user.avatar }}"
                                        onerror="this.src='https://ui-avatars.com/api/?name={{ user.username_plain }}&background=random'"
                                        class="user-avatar" />
                                </td>
                                <td>
                                    <a
                                        href="{{ user.profile_url }}"
                                        target="_blank"
                                        class="username-link">
                                        @{{ user.username_plain }}
                                    </a>
                                </td>
                                <td class="small">{{ user.tg_id }}</td>

                                <td class="text-center">
                                    <span class="stat-badge count-important">
                                        üí¨ {{ user.msg_count }}
                                    </span>
                                </td>
                                <td class="text-center">
                                    <span class="stat-badge media-count">
                                        <span class="small"
                                            >üñºÔ∏è {{ user.photo_count }}</span
                                        >
                                        <span
                                            class="mobile-hide"
                                            style="color: #30363d"
                                            >|</span
                                        >
                                        <span class="small"
                                            >üé• {{ user.video_count }}</span
                                        >
                                    </span>
                                </td>
                                <td class="text-center">
                                    <span class="stat-badge count-important"
                                        >‚ú® {{ user.sticker_count }}</span
                                    >
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <script>
            // –ü–æ–∏—Å–∫ (—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è)
            document
                .getElementById("searchInput")
                .addEventListener("input", function () {
                    const filter = this.value.toLowerCase();
                    const rows = document.querySelectorAll("#tableBody tr");
                    rows.forEach((row) => {
                        row.style.display = row.innerText
                            .toLowerCase()
                            .includes(filter)
                            ? ""
                            : "none";
                    });
                });

            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
            function sortTable(columnIndex) {
                console.log("function called for column:", columnIndex);
                const table = document.getElementById("usersTable");
                const tbody = document.getElementById("tableBody");
                const rows = Array.from(tbody.querySelectorAll("tr"));
                const th = table.querySelectorAll("th")[columnIndex];

                // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                const isAscending = !th.classList.contains("sort-asc");

                // –ß–∏—Å—Ç–∏–º —Å—Ç–∏–ª–∏ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
                table
                    .querySelectorAll("th")
                    .forEach((h) =>
                        h.classList.remove("sort-asc", "sort-desc"),
                    );
                th.classList.add(isAscending ? "sort-asc" : "sort-desc");

                rows.sort((a, b) => {
                    let valA = a.children[columnIndex].innerText.trim();
                    let valB = b.children[columnIndex].innerText.trim();

                    // –ï—Å–ª–∏ –∫–æ–ª–æ–Ω–∫–∞ –Ω–µ —Ç–µ–∫—Å—Ç–æ–≤–∞—è (–≤—Å–µ, –∫—Ä–æ–º–µ "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å" –ø–æ–¥ –∏–Ω–¥–µ–∫—Å–æ–º 2)
                    if (columnIndex !== 2) {
                        // –í—ã–¥–∏—Ä–∞–µ–º –≤—Å–µ —Ü–∏—Ñ—Ä—ã. –ï—Å–ª–∏ –≤ —è—á–µ–π–∫–µ "üñºÔ∏è 10 | üé• 5", –ø–æ–ª—É—á–∏—Ç—Å—è "105" –∏–ª–∏ "15"
                        // –î–ª—è –∫–æ–ª–æ–Ω–æ–∫ —Å –æ–¥–Ω–∏–º —á–∏—Å–ª–æ–º —ç—Ç–æ –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç "üí¨ 100" –≤ 100
                        valA = parseInt(valA.replace(/\D/g, "")) || 0;
                        valB = parseInt(valB.replace(/\D/g, "")) || 0;

                        console.log(valA, valB);
                        return isAscending ? valA - valB : valB - valA;
                    }

                    // –î–ª—è –∏–º–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ—Å—Ç–∞–≤–ª—è–µ–º –æ–±—ã—á–Ω—É—é —Å—Ç—Ä–æ–∫—É
                    return isAscending
                        ? valA.localeCompare(valB)
                        : valB.localeCompare(valA);
                });

                // –û—á–∏—â–∞–µ–º –∏ –∑–∞–∫–∏–¥—ã–≤–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ
                tbody.innerHTML = "";
                rows.forEach((row) => tbody.appendChild(row));
            }
        </script>
    </body>
</html>
